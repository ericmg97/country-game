<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Juego de Pa√≠ses</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
  <div id="map"></div>
  <div class="clue-container" id="clueContainer">
    <div class="clue-info">
      <span id="clueNumber">Afirmaci√≥n 1 de 7</span>
      <div>
        <span class="remaining-countries" id="remainingCount"></span>
        <span class="error-counter" id="errorCount">0 fallos</span>
      </div>
    </div>
    <div class="clue-text" id="clueText"></div>
  </div>
  <div class="countries-sidebar">
    <div class="sidebar-title">Pa√≠ses Disponibles</div>
    <ul class="countries-list" id="countriesList">
      <!-- Countries will be added here dynamically -->
    </ul>
  </div>
  <div class="message-container" id="message"></div>
  <div class="modal-overlay" id="instructionsModal">
    <div class="modal">
      <h2>¬°Bienvenido al juego que te llevar√° a tu destino sorpresa! üéÅ</h2>
      
      <div class="instructions-content">
        <p class="main-description">Se te presentar√°n varias afirmaciones sobre pa√≠ses.</p>
        
        <div class="instructions-list">
          <p><strong>Tu objetivo:</strong> Identificar y hacer clic en los pa√≠ses que <strong>NO</strong> cumplen con la afirmaci√≥n mostrada.</p>
          
          <ul>
            <li>Puedes hacer clic en el pa√≠s directamente en el mapa o en su nombre en la lista a la izquierda para seleccionarlo</li>
            <li>Cuando selecciones todos los pa√≠ses que no cumplan con una afirmaci√≥n, pasar√°s a la siguiente.</li>
            <li>Los pa√≠ses correctamente seleccionados se volver√°n grises y ser√°n descartados como posibles destinos</li>
          </ul>
          
          <p class="highlight-text">Al final del juego, ¬°solo quedar√° tu destino sorpresa! üéâ</p>
          
          <p class="warning-text">‚ö†Ô∏è Importante: Con m√°s de 5 fallos, se cancela autom√°ticamente la reserva.</p>
        </div>
      </div>
      
      <button class="start-button" onclick="startGame()">¬°Comenzar la Aventura!</button>
    </div>
  </div>
  <div class="modal-overlay" id="finalModal" style="display: none;">
    <div class="final-modal">
      <h2>¬°Felicitaciones! üéâ</h2>
      
      <div class="victory-content">
        <p class="victory-message">Eres un as de la geopol√≠tica! Pero eso ya lo sab√≠amos üòä</p>
        
        <div class="destination-reveal">
          <p class="reveal-text">Tu destino sorpresa son <strong>dos destinos</strong>:</p>
          <div class="final-countries">
            <div class="final-country">
              <span class="country-emoji">üá´üáÆ</span>
              <span class="country-name">Finlandia</span>
            </div>
            <div class="final-country">
              <span class="country-emoji">üá™üá™</span>
              <span class="country-name">Estonia</span>
            </div>
          </div>
        </div>
        
        <p class="error-summary">Total de fallos: <span id="finalErrorCount">0</span></p>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="gameOverModal" style="display: none;">
    <div class="final-modal game-over">
      <h2>Lo sentimos, ha perdido el juego y con ello, su sorpresa üíî</h2>
      
      <div class="game-over-content">
        <p class="restart-message">La buena noticia es que puede reiniciarlo.</p>
        <p class="condition-message">Solo debe decirle a su novia que es la mejor del mundo üòÅ</p>
        
        <button class="start-button" onclick="restartGame()">Reintentar</button>
      </div>
    </div>
  </div>
  <script>
    var clues = [
      { 
        text: "El ingl√©s no es idioma oficial", 
        remove: ["Malta"],
        explanations: {
          "Malta": "Malta tiene el ingl√©s como idioma oficial junto con el malt√©s desde su independencia en 1964"
        }
      },
      { 
        text: "El pa√≠s est√° en Europa", 
        remove: ["Tunez", "Senegal"],
        explanations: {
          "Tunez": "T√∫nez est√° ubicado en el norte de √Åfrica, en la costa mediterr√°nea",
          "Senegal": "Senegal est√° ubicado en √Åfrica occidental, bordeando el Oc√©ano Atl√°ntico"
        }
      },
      { 
        text: "Tiene inviernos con temperaturas menores a 15¬∞C", 
        remove: ["Madeira", "Chipre"],
        explanations: {
          "Madeira": "Madeira tiene un clima subtropical con inviernos suaves, temperaturas promedio entre 16-20¬∞C",
          "Chipre": "Chipre tiene inviernos mediterr√°neos suaves con temperaturas promedio entre 15-18¬∞C en la costa"
        }
      },
      { 
        text: "Tiene salida al mar", 
        remove: ["Liechtenstein", "Macedonia"],
        explanations: {
          "Liechtenstein": "Liechtenstein es un pa√≠s sin salida al mar, ubicado entre Suiza y Austria",
          "Macedonia": "Macedonia del Norte es un pa√≠s sin salida al mar en los Balcanes"
        }
      },
      { 
        text: "Espec√≠ficamente, tiene acceso al mar B√°ltico", 
        remove: ["Croacia", "Eslovenia", "Noruega"],
        explanations: {
          "Croacia": "Croacia tiene costa en el mar Adri√°tico, no en el mar B√°ltico",
          "Eslovenia": "Eslovenia tiene una peque√±a costa en el mar Adri√°tico, no en el mar B√°ltico",
          "Noruega": "Noruega tiene costa en el mar del Norte y mar de Noruega, pero no en el mar B√°ltico"
        }
      },
      { 
        text: "Su capital tiene salida a un golfo", 
        remove: ["Lituania"],
        explanations: {
          "Lituania": "Vilna, la capital de Lituania, est√° ubicada tierra adentro y no tiene acceso directo al mar"
        }
      },
      { 
        text: "A 80km por mar tiene otra capital europea", 
        remove: ["Letonia", "Suecia"],
        explanations: {
          "Letonia": "Riga, la capital de Letonia, est√° a m√°s de 80km por mar de cualquier otra capital europea",
          "Suecia": "Estocolmo, la capital de Suecia, est√° a m√°s de 80km por mar de cualquier otra capital europea"
        }
      }
    ];

    var currentClueIndex = 0;
    var map = L.map('map', {
        minZoom: 3,      // No permitir alejar m√°s del zoom inicial
        maxZoom: 5       // Limitar tambi√©n el zoom in para una mejor experiencia
        }).setView([55, 15], 3);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data ¬© OpenStreetMap contributors'
    }).addTo(map);

        // Lista de candidatos actualizada con nombres en ingl√©s para GeoJSON
    var candidates = [
      { name: "Madeira", geoName: "Portugal", lat: 32.7607, lng: -16.9595 },
      { name: "Finlandia", geoName: "Finland", lat: 60.1699, lng: 24.9384 },
      { name: "Chipre", geoName: "Cyprus", lat: 35.1264, lng: 33.4299 },
      { name: "Croacia", geoName: "Croatia", lat: 45.1000, lng: 15.2000 },
      { name: "Senegal", geoName: "Senegal", lat: 14.7167, lng: -17.4677 },
      { name: "Macedonia", geoName: "Macedonia", lat: 41.6086, lng: 21.7453 },
      { name: "Malta", geoName: "Malta", lat: 35.9375, lng: 14.3754 },
      { name: "Liechtenstein", geoName: "Liechtenstein", lat: 47.1660, lng: 9.5554 },
      { name: "Estonia", geoName: "Estonia", lat: 59.4370, lng: 24.7536 },
      { name: "Noruega", geoName: "Norway", lat: 59.9139, lng: 10.7522 },
      { name: "Letonia", geoName: "Latvia", lat: 56.9460, lng: 24.1059 },
      { name: "Tunez", geoName: "Tunisia", lat: 36.8065, lng: 10.1815 },
      { name: "Lituania", geoName: "Lithuania", lat: 54.6872, lng: 25.2797 },
      { name: "Eslovenia", geoName: "Slovenia", lat: 46.1512, lng: 14.9955 },
      { name: "Suecia", geoName: "Sweden", lat: 59.3293, lng: 18.0686 }
    ];

    // Update the GeoJSON section
    var countryLayers = {};

    // Add variable to store label markers
    var labelMarkers = {};

    var errorCount = 0;
    var isProcessing = false;
    var messageTimeout = null;
    var gameActive = true;

    function vibrate(pattern) {
      if (navigator.vibrate) {
        navigator.vibrate(pattern);
      }
    }

    function startGame() {
      document.getElementById('instructionsModal').style.display = 'none';
      
      // Enable game
      gameActive = true;
      
      // Show the clue container and sidebar with animation
      const clueContainer = document.getElementById('clueContainer');
      const countriesSidebar = document.querySelector('.countries-sidebar');
      
      clueContainer.classList.add('visible');
      countriesSidebar.classList.add('visible');
      
      errorCount = 0;
      document.getElementById("errorCount").innerHTML = "0 fallos";
      updateClue();
    }

    function updateClue() {
      if (currentClueIndex < clues.length) {
        const clueContainer = document.getElementById("clueContainer");
        const clueText = document.getElementById("clueText");
        const clueNumber = document.getElementById("clueNumber");
        const remainingCount = document.getElementById("remainingCount");

        // Add new-clue class for animations
        clueContainer.classList.add('new-clue');
        clueText.classList.add('new-clue');

        // Update the content
        clueNumber.innerHTML = `Afirmaci√≥n ${currentClueIndex + 1} de ${clues.length}`;
        clueText.innerHTML = clues[currentClueIndex].text;
        remainingCount.innerHTML = `${clues[currentClueIndex].remove.length} pa√≠ses restantes`;

        // Remove animation classes after animation completes
        setTimeout(() => {
          clueContainer.classList.remove('new-clue');
          clueText.classList.remove('new-clue');
        }, 1000);

        // Add stronger vibration feedback for new clue
        vibrate([100, 50, 100]);
      }
    }

    // Mover estas funciones fuera del fetch y antes de √©l
    function createCountriesList() {
      const countriesList = document.getElementById('countriesList');
      countriesList.innerHTML = ''; // Limpiar la lista primero
      candidates.forEach(candidate => {
        const li = document.createElement('li');
        li.className = 'country-item';
        li.id = `country-item-${candidate.name}`;
        li.textContent = candidate.name;
        li.onclick = () => {
          const layer = countryLayers[candidate.name];
          if (layer) {
            checkSelection(candidate.name, layer);
          }
        };
        countriesList.appendChild(li);
      });
    }

    function markCountryAsRemoved(country) {
      const countryItem = document.getElementById(`country-item-${country}`);
      if (countryItem) {
        countryItem.classList.add('removed');
      }
    }

    // Modificar el fetch para eliminar el c√≥digo duplicado y las definiciones de funciones
    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
      .then(response => response.json())
      .then(data => {
        // Add Liechtenstein manually if it's not in the GeoJSON
        const liechtensteinGeoJSON = {
          type: "Feature",
          properties: { name: "Liechtenstein" },
          geometry: {
            type: "Polygon",
            coordinates: [[
              [9.5357, 47.2496],
              [9.4797, 47.0547],
              [9.6321, 47.0572],
              [9.6355, 47.2701],
              [9.5357, 47.2496]
            ]]
          }
        };
        data.features.push(liechtensteinGeoJSON);

        L.geoJSON(data, {
          style: function(feature) {
            const hue = Math.random() * 360;
            return {
              fillColor: `hsl(${hue}, 70%, 85%)`,
              color: '#666',
              weight: 2,
              fillOpacity: 0.6
            };
          },
          filter: function(feature) {
            return candidates.some(c => 
              feature.properties.name === c.geoName ||
              feature.properties.name_long === c.geoName ||
              feature.properties.admin === c.geoName ||
              feature.properties.sovereignt === c.geoName
            );
          },
          onEachFeature: function(feature, layer) {
            let candidate = candidates.find(c => 
              c.geoName === feature.properties.name ||
              c.geoName === feature.properties.name_long ||
              c.geoName === feature.properties.admin ||
              c.geoName === feature.properties.sovereignt
            );

            if (candidate) {
              countryLayers[candidate.name] = layer;

              const center = layer.getBounds().getCenter();
              const labelMarker = L.marker(center, {
                icon: L.divIcon({
                  className: 'country-label',
                  html: `<div class="country-name">${candidate.name}</div>`,
                  iconSize: [100, 40],
                  iconAnchor: [50, 20]
                })
              }).addTo(map);

              labelMarkers[candidate.name] = labelMarker;

              labelMarker.on('click', function() {
                checkSelection(candidate.name, layer);
              });

              layer.on({
                click: function() {
                  checkSelection(candidate.name, layer);
                },
                mouseover: function(e) {
                  layer.setStyle({
                    fillOpacity: 0.8,
                    weight: 3
                  });
                },
                mouseout: function(e) {
                  layer.setStyle({
                    fillOpacity: 0.6,
                    weight: 2
                  });
                }
              });
            }
          }
        }).addTo(map);

        // Crear la lista de pa√≠ses despu√©s de que el mapa est√© listo
        createCountriesList();
      })
      .catch(error => {
        console.error('Error loading GeoJSON:', error);
        document.getElementById("message").className = "message-container error-message";
        document.getElementById("message").innerHTML = "Error cargando el mapa. Por favor, recarga la p√°gina.";
      });

    function showMessage(message, isSuccess) {
      const messageContainer = document.getElementById("message");
      
      // Clear any existing timeouts
      if (messageTimeout) {
        clearTimeout(messageTimeout);
        messageTimeout = null;
      }
      
      // If a message is currently animating out, remove the animation and show new message immediately
      if (messageContainer.classList.contains('hiding')) {
        messageContainer.classList.remove('hiding');
        messageContainer.style.display = 'block';
      }
      
      // Set the message and style
      messageContainer.innerHTML = message;
      messageContainer.className = `message-container ${isSuccess ? 'success-message' : 'error-message'}`;
      
      // Show the message
      messageContainer.style.display = 'block';
      
      // Set new timeout
      messageTimeout = setTimeout(() => {
        // Only start hiding if this is still the active timeout
        if (messageTimeout) {
          messageContainer.classList.add('hiding');
          setTimeout(() => {
            // Only hide if the message hasn't been updated
            if (messageContainer.classList.contains('hiding')) {
              messageContainer.style.display = 'none';
            }
          }, 500); // Animation duration
        }
      }, 4000);
    }

    function checkSelection(country, layer) {
      if (isProcessing || !gameActive) return;
      isProcessing = true;

      // Create celebration effect function
      function showAnimation(text, isSuccess) {
        // Add vibration patterns
        if (isSuccess) {
          vibrate([100]); // Short vibration for success
        } else {
          vibrate([100, 100, 100]); // Three short vibrations for error
        }

        const bounds = layer.getBounds();
        const center = bounds.getCenter();
        const point = map.latLngToContainerPoint(center);
        
        const celebration = document.createElement('div');
        celebration.className = `celebration ${isSuccess ? 'success' : 'error'}`;
        celebration.style.left = `${point.x}px`;
        celebration.style.top = `${point.y}px`;
        celebration.innerHTML = text;
        document.body.appendChild(celebration);
        
        setTimeout(() => {
          if (celebration.parentNode) {
            celebration.parentNode.removeChild(celebration);
          }
          isProcessing = false;
        }, 1000);
      }

      // Limpiar cualquier mensaje previo
      document.getElementById("message").innerHTML = "";
      document.getElementById("message").className = "message-container";

      if (clues[currentClueIndex].remove.includes(country)) {
        showAnimation('¬°Correcto! üéâ', true);
        
        // Add the animation class
        const countryItem = document.getElementById(`country-item-${country}`);
        if (countryItem) {
          countryItem.classList.add('correct');
          // Wait for the animation to complete before adding the removed class
          setTimeout(() => {
            countryItem.classList.add('removed');
          }, 500);
        }

        layer.setStyle({
          fillColor: '#808080',
          fillOpacity: 0.3,
          color: '#666',
          weight: 1
        });
        layer.off('mouseover mouseout click');

        if (labelMarkers[country]) {
          map.removeLayer(labelMarkers[country]);
          delete labelMarkers[country];
        }

        markCountryAsRemoved(country);

        const explanation = clues[currentClueIndex].explanations[country];
        showMessage(explanation, true);

        clues[currentClueIndex].remove = clues[currentClueIndex].remove.filter(c => c !== country);
        document.getElementById("remainingCount").innerHTML = `${clues[currentClueIndex].remove.length} pa√≠ses restantes`;

        if (clues[currentClueIndex].remove.length === 0) {
          currentClueIndex++;
          if (currentClueIndex >= clues.length) {
            // Disable game immediately
            gameActive = false;
            
            // First update the final error count
            document.getElementById("finalErrorCount").innerHTML = errorCount;
            
            // Wait for the message to finish before showing the final modal and hiding elements
            setTimeout(() => {
              // Show final modal first
              document.getElementById("finalModal").style.display = "flex";
              
              // Then start the fade out animation for the containers
              const clueContainer = document.getElementById("clueContainer");
              const countriesSidebar = document.querySelector(".countries-sidebar");
              
              clueContainer.classList.remove('visible');
              countriesSidebar.classList.remove('visible');
              
              // After animation completes, hide completely
              setTimeout(() => {
                clueContainer.style.display = "none";
                countriesSidebar.style.display = "none";
              }, 300);
              
            }, 4500);
          } else {
            updateClue();
          }
        }
      } else {
        showAnimation('¬°Incorrecto! ‚ùå', false);
        
        const countryItem = document.getElementById(`country-item-${country}`);
        if (countryItem) {
          countryItem.classList.add('incorrect');
          setTimeout(() => {
            countryItem.classList.remove('incorrect');
          }, 400);
        }

        errorCount++;
        document.getElementById("errorCount").innerHTML = `${errorCount} fallos`;
        
        if (errorCount >= 5) {
          // Disable game immediately
          gameActive = false;
          
          // Show error message first
          showMessage("¬°Error! Este pa√≠s s√≠ cumple la afirmaci√≥n.", false);
          
          // Wait for the full message duration before starting game over sequence
          setTimeout(() => {
            const clueContainer = document.getElementById("clueContainer");
            const countriesSidebar = document.querySelector(".countries-sidebar");
            
            clueContainer.classList.remove('visible');
            countriesSidebar.classList.remove('visible');
            
            // After fade-out animation, show game over modal
            setTimeout(() => {
              clueContainer.style.display = "none";
              countriesSidebar.style.display = "none";
              document.getElementById("gameOverModal").style.display = "flex";
              // Now we can hide the message
              document.getElementById("message").style.display = "none";
            }, 300);
          }, 4000);
        } else {
          showMessage("¬°Error! Este pa√≠s s√≠ cumple la afirmaci√≥n.", false);
        }
      }
    }

    // Add these new functions after the startGame function
    function restartGame() {
      // Hide game over modal
      document.getElementById('gameOverModal').style.display = 'none';
      
      // Enable game
      gameActive = true;
      
      // Reset the game state
      currentClueIndex = 0;
      errorCount = 0;
      
      // Reset all countries
      candidates.forEach(candidate => {
        const layer = countryLayers[candidate.name];
        if (layer) {
          layer.setStyle({
            fillColor: `hsl(${Math.random() * 360}, 70%, 85%)`,
            fillOpacity: 0.6,
            color: '#666',
            weight: 2
          });
          
          // Re-attach event listeners
          layer.on({
            click: function() {
              checkSelection(candidate.name, layer);
            },
            mouseover: function(e) {
              layer.setStyle({
                fillOpacity: 0.8,
                weight: 3
              });
            },
            mouseout: function(e) {
              layer.setStyle({
                fillOpacity: 0.6,
                weight: 2
              });
            }
          });
        }
        
        // Restore label if it was removed
        if (!labelMarkers[candidate.name]) {
          const center = countryLayers[candidate.name].getBounds().getCenter();
          const labelMarker = L.marker(center, {
            icon: L.divIcon({
              className: 'country-label',
              html: `<div class="country-name">${candidate.name}</div>`,
              iconSize: [100, 40],
              iconAnchor: [50, 20]
            })
          }).addTo(map);

          labelMarkers[candidate.name] = labelMarker;
          labelMarker.on('click', function() {
            checkSelection(candidate.name, countryLayers[candidate.name]);
          });
        }
      });
      
      // Reset clues
      clues.forEach(clue => {
        clue.remove = [...clue.originalRemove];
      });
      
      // Show UI elements
      const clueContainer = document.getElementById('clueContainer');
      const countriesSidebar = document.querySelector('.countries-sidebar');
      
      clueContainer.style.display = '';
      countriesSidebar.style.display = '';
      clueContainer.classList.add('visible');
      countriesSidebar.classList.add('visible');
      
      // Reset error counter display
      document.getElementById("errorCount").innerHTML = "0 fallos";
      
      // Recreate countries list
      createCountriesList();
      
      // Update first clue
      updateClue();
    }

    // Add this right after the clues array definition to store original remove arrays
    clues.forEach(clue => {
      clue.originalRemove = [...clue.remove];
    });
  </script>
</body>
</html>
