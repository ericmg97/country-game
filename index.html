<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Juego de Pa√≠ses</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100vh; width: 100vw; }
    .sidebar {
      position: absolute; top: 20px; left: 20px; background: white;
      padding: 15px; z-index: 1000; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      max-width: 300px;
    }
    button { margin-top: 5px; }
    .error { color: red; font-weight: bold; }
    .country-boundary {
      fill: none;
      stroke: #232323;
      stroke-width: 1;
      stroke-linejoin: round;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .start-button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
      transition: background 0.3s;
    }
    .start-button:hover {
      background: #45a049;
    }
    @keyframes celebrate {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      50% {
        transform: translate(-50%, -100%) scale(1.5);
        opacity: 0.5;
      }
      100% {
        transform: translate(-50%, -150%) scale(2);
        opacity: 0;
      }
    }
    .celebration {
      position: fixed;
      pointer-events: none;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      animation: celebrate 1s ease-out forwards;
      z-index: 2000;
      text-align: center;
      white-space: nowrap;
    }
    .celebration.success {
      color: #4CAF50;
    }
    .celebration.error {
      color: #ff3333;
    }
    .clue-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      text-align: center;
      min-width: 300px;
      backdrop-filter: blur(5px);
      border: 2px solid #4CAF50;
      transition: all 0.3s ease;
    }
    .clue-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 14px;
      color: #666;
    }
    .remaining-countries {
      background: #4CAF50;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 12px;
    }
    .clue-text {
      font-size: 18px;
      color: #333;
      font-weight: 500;
      padding: 5px 0;
    }
    .message-container {
      position: fixed;
      top: calc(20px + 100px); /* Closer to clue container */
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      text-align: center;
      min-width: 200px;
      backdrop-filter: blur(5px);
      display: none;
      animation: slideInDown 0.3s ease-out;
      transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    }
    .message-container.hiding {
      animation: slideOutUp 0.3s ease-in forwards;
    }
    .success-message {
      color: #4CAF50;
      font-weight: bold;
    }
    .error-message {
      color: #ff3333;
      font-weight: bold;
    }
    .final-modal {
      background: white;
      padding: 40px;
      border-radius: 15px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      animation: fadeIn 0.5s ease-out;
    }
    .final-modal h2 {
      color: #4CAF50;
      margin-bottom: 20px;
      font-size: 28px;
    }
    .final-modal p {
      font-size: 18px;
      color: #333;
      margin: 15px 0;
    }
    .final-countries {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    .final-country {
      background: #f0f9f0;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: bold;
      color: #4CAF50;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .error-counter {
      background: #ff3333;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 12px;
      margin-left: 8px;
    }
    @keyframes clueFlash {
      0% { 
        transform: translateX(-50%) scale(1); 
        background: rgba(255, 255, 255, 0.95); 
      }
      50% { 
        transform: translateX(-50%) scale(1.02); 
        background: rgba(76, 175, 80, 0.2); 
      }
      100% { 
        transform: translateX(-50%) scale(1); 
        background: rgba(255, 255, 255, 0.95); 
      }
    }
    @keyframes textFadeIn {
      0% { 
        opacity: 0; 
        transform: translateY(-10px); 
      }
      100% { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    .clue-container.animate {
      animation: clueFlash 0.5s ease-out;
      transform-origin: center;
    }
    .clue-text.animate {
      animation: textFadeIn 0.5s ease-out;
    }
    @media (max-width: 768px) {
      .clue-container {
        min-width: 85%;
        padding: 20px;
        top: 10px;
      }

      .clue-text {
        font-size: 22px;
        line-height: 1.4;
        padding: 10px 0;
      }

      .clue-info {
        font-size: 16px;
        margin-bottom: 15px;
      }

      .remaining-countries {
        font-size: 14px;
        padding: 4px 12px;
      }

      .error-counter {
        font-size: 14px;
        padding: 4px 12px;
      }

      .message-container {
        top: calc(10px + 130px); /* Closer to mobile clue container */
        min-width: 85%;
        padding: 15px 20px;
        font-size: 18px;
      }

      .country-label div {
        font-size: 18px;
        width: 120px;
        text-shadow: 
          3px 3px 3px white,
          -3px 3px 3px white,
          3px -3px 3px white,
          -3px -3px 3px white;
      }

      .celebration {
        font-size: 32px;
      }

      /* Estilos para modales en m√≥vil */
      .modal {
        width: 85%;
        padding: 25px;
        margin: 20px;
      }

      .modal ul {
        padding-left: 20px;
      }

      .modal li {
        font-size: 16px;
        margin-bottom: 10px;
      }

      .start-button {
        font-size: 18px;
        padding: 15px 30px;
      }

      .final-modal {
        width: 85%;
        padding: 30px;
      }

      .final-modal h2 {
        font-size: 26px;
      }

      .final-modal p {
        font-size: 20px;
      }

      .final-country {
        font-size: 18px;
        padding: 12px 24px;
      }

      /* Update the mobile styles for the countries sidebar */
      .countries-sidebar {
        position: fixed;
        top: auto;
        bottom: 5px; /* Cambiado de 20px a 5px para ponerlo m√°s abajo */
        left: 50%;
        transform: translateX(-50%);
        width: 85%;
        max-height: 120px; /* Reducido de 150px a 120px */
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.98);
        z-index: 1001;
        padding: 10px; /* Reducido el padding */
      }

      .countries-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        padding-bottom: 5px; /* Add some padding at the bottom */
      }

      .country-item {
        font-size: 14px;
        padding: 6px 10px;
        margin: 0; /* Remove vertical margins */
      }

      /* Add some bottom padding to the map container to prevent the list from covering the bottom of the map */
      #map {
        padding-bottom: 130px; /* Ajustado para el nuevo tama√±o */
      }

      .sidebar-title {
        font-size: 14px; /* Reducido el tama√±o del t√≠tulo */
        margin-bottom: 5px; /* Menos espacio debajo del t√≠tulo */
      }
    }

    /* Additional adjustments for very small screens */
    @media (max-width: 360px) {
      .clue-text {
        font-size: 20px;
      }

      .country-label div {
        font-size: 16px;
        width: 100px;
      }

      .modal {
        padding: 20px;
      }

      .modal li {
        font-size: 14px;
      }

      .countries-sidebar {
        bottom: 2px; /* A√∫n m√°s abajo para pantallas peque√±as */
        max-height: 100px; /* Altura m√°xima m√°s peque√±a */
      }

      .country-item {
        font-size: 12px;
        padding: 4px 8px;
      }

      #map {
        padding-bottom: 110px; /* Ajustado para pantallas peque√±as */
      }
    }
    .countries-sidebar {
      position: fixed;
      top: 50%;
      left: 20px;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      backdrop-filter: blur(5px);
      border: 2px solid #4CAF50;
      max-height: 70vh;
      overflow-y: auto;
      width: 200px;
    }

    .countries-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .country-item {
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 8px;
      background: #f0f9f0;
      color: #333;
      font-weight: 500;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .country-item:hover {
      background: #4CAF50;
      color: white;
    }

    .country-item.removed {
      background: #e0e0e0 !important;
      color: #666 !important;
      text-decoration: line-through;
      pointer-events: none;
      position: relative;
    }

    .country-item.removed::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
    }

    .sidebar-title {
      font-size: 16px;
      color: #333;
      margin-bottom: 10px;
      text-align: center;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .countries-sidebar {
        position: fixed;
        top: auto;
        bottom: 5px; /* Cambiado de 20px a 5px para ponerlo m√°s abajo */
        left: 50%;
        transform: translateX(-50%);
        width: 85%;
        max-height: 120px; /* Reducido de 150px a 120px */
        display: flex;
        flex-direction: column;
      }

      .countries-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
      }

      .country-item {
        font-size: 14px;
        padding: 6px 10px;
      }
    }

    /* Add these new animations to your CSS section */
    @keyframes slideInDown {
      from {
        transform: translate(-50%, -20px);
        opacity: 0;
      }
      to {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }

    @keyframes slideOutUp {
      from {
        transform: translate(-50%, 0);
        opacity: 1;
      }
      to {
        transform: translate(-50%, -20px);
        opacity: 0;
      }
    }

    @keyframes shakeItem {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }

    @keyframes fadeOutItem {
      0% { 
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.5;
      }
      100% { 
        transform: scale(0.9);
        opacity: 0;
      }
    }

    .country-item.incorrect {
      animation: shakeItem 0.4s ease-in-out;
      background: rgba(255, 51, 51, 0.2);
    }

    /* Update the animations and styles for country items */
    @keyframes correctItem {
      0% { 
        transform: scale(1);
        background: #f0f9f0;
      }
      50% {
        transform: scale(1.1);
        background: #e0e0e0;
        color: #666;
      }
      100% { 
        transform: scale(1);
        background: #e0e0e0;
        color: #666;
      }
    }

    .country-item.correct {
      animation: correctItem 0.5s ease-out forwards;
    }

    /* Add this CSS for initial state */
    .clue-container, .countries-sidebar {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .clue-container.visible, .countries-sidebar.visible {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="clue-container" id="clueContainer">
    <div class="clue-info">
      <span id="clueNumber">Afirmaci√≥n 1 de 7</span>
      <div>
        <span class="remaining-countries" id="remainingCount"></span>
        <span class="error-counter" id="errorCount">0 fallos</span>
      </div>
    </div>
    <div class="clue-text" id="clueText"></div>
  </div>
  <div class="countries-sidebar">
    <div class="sidebar-title">Pa√≠ses Disponibles</div>
    <ul class="countries-list" id="countriesList">
      <!-- Countries will be added here dynamically -->
    </ul>
  </div>
  <div class="message-container" id="message"></div>
  <div class="modal-overlay" id="instructionsModal">
    <div class="modal">
      <h2>¬°Bienvenido al Juego de Pa√≠ses!</h2>
      <p>Instrucciones:</p>
      <ul style="text-align: left;">
        <li>Se te presentar√°n varias afirmaciones sobre pa√≠ses.</li>
        <li>Tu objetivo es identificar y hacer clic en los pa√≠ses que <strong>NO</strong> cumplen con la afirmaci√≥n mostrada.</li>
        <li>Puedes hacer clic en el pa√≠s o en su nombre para seleccionarlo.</li>
        <li>Los pa√≠ses correctamente seleccionados se volver√°n grises.</li>
        <li>Cuando encuentres todos los pa√≠ses de una afirmaci√≥n, pasar√°s a la siguiente.</li>
      </ul>
      <button class="start-button" onclick="startGame()">¬°Comenzar!</button>
    </div>
  </div>
  <div class="modal-overlay" id="finalModal" style="display: none;">
    <div class="final-modal">
      <h2>¬°Felicitaciones! üéâ</h2>
      <p>Has completado todas las afirmaciones correctamente.</p>
      <p class="final-errors">Total de fallos: <span id="finalErrorCount">0</span></p>
      <p>Los pa√≠ses finales son:</p>
      <div class="final-countries">
        <div class="final-country">Estonia</div>
        <div class="final-country">Finlandia</div>
      </div>
    </div>
  </div>
  <script>
    var clues = [
      { 
        text: "El ingl√©s no es idioma oficial", 
        remove: ["Malta"],
        explanations: {
          "Malta": "Malta tiene el ingl√©s como idioma oficial junto con el malt√©s desde su independencia en 1964"
        }
      },
      { 
        text: "El pa√≠s est√° en Europa", 
        remove: ["Tunez", "Senegal"],
        explanations: {
          "Tunez": "T√∫nez est√° ubicado en el norte de √Åfrica, en la costa mediterr√°nea",
          "Senegal": "Senegal est√° ubicado en √Åfrica occidental, bordeando el Oc√©ano Atl√°ntico"
        }
      },
      { 
        text: "Tiene inviernos con temperaturas menores a 15¬∞C", 
        remove: ["Madeira", "Chipre"],
        explanations: {
          "Madeira": "Madeira tiene un clima subtropical con inviernos suaves, temperaturas promedio entre 16-20¬∞C",
          "Chipre": "Chipre tiene inviernos mediterr√°neos suaves con temperaturas promedio entre 15-18¬∞C en la costa"
        }
      },
      { 
        text: "Tiene salida al mar", 
        remove: ["Liechtenstein", "Macedonia"],
        explanations: {
          "Liechtenstein": "Liechtenstein es un pa√≠s sin salida al mar, ubicado entre Suiza y Austria",
          "Macedonia": "Macedonia del Norte es un pa√≠s sin salida al mar en los Balcanes"
        }
      },
      { 
        text: "Espec√≠ficamente, tiene acceso al mar B√°ltico", 
        remove: ["Croacia", "Eslovenia", "Noruega"],
        explanations: {
          "Croacia": "Croacia tiene costa en el mar Adri√°tico, no en el mar B√°ltico",
          "Eslovenia": "Eslovenia tiene una peque√±a costa en el mar Adri√°tico, no en el mar B√°ltico",
          "Noruega": "Noruega tiene costa en el mar del Norte y mar de Noruega, pero no en el mar B√°ltico"
        }
      },
      { 
        text: "Su capital tiene salida a un golfo", 
        remove: ["Lituania"],
        explanations: {
          "Lituania": "Vilna, la capital de Lituania, est√° ubicada tierra adentro y no tiene acceso directo al mar"
        }
      },
      { 
        text: "A 80km por mar tiene otra capital europea", 
        remove: ["Letonia", "Suecia"],
        explanations: {
          "Letonia": "Riga, la capital de Letonia, est√° a m√°s de 80km por mar de cualquier otra capital europea",
          "Suecia": "Estocolmo, la capital de Suecia, est√° a m√°s de 80km por mar de cualquier otra capital europea"
        }
      }
    ];

    var currentClueIndex = 0;
    var map = L.map('map', {
        minZoom: 3,      // No permitir alejar m√°s del zoom inicial
        maxZoom: 5       // Limitar tambi√©n el zoom in para una mejor experiencia
        }).setView([55, 15], 3);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data ¬© OpenStreetMap contributors'
    }).addTo(map);

        // Lista de candidatos actualizada con nombres en ingl√©s para GeoJSON
    var candidates = [
      { name: "Madeira", geoName: "Portugal", lat: 32.7607, lng: -16.9595 },
      { name: "Finlandia", geoName: "Finland", lat: 60.1699, lng: 24.9384 },
      { name: "Chipre", geoName: "Cyprus", lat: 35.1264, lng: 33.4299 },
      { name: "Croacia", geoName: "Croatia", lat: 45.1000, lng: 15.2000 },
      { name: "Senegal", geoName: "Senegal", lat: 14.7167, lng: -17.4677 },
      { name: "Macedonia", geoName: "Macedonia", lat: 41.6086, lng: 21.7453 },
      { name: "Malta", geoName: "Malta", lat: 35.9375, lng: 14.3754 },
      { name: "Liechtenstein", geoName: "Liechtenstein", lat: 47.1660, lng: 9.5554 },
      { name: "Estonia", geoName: "Estonia", lat: 59.4370, lng: 24.7536 },
      { name: "Noruega", geoName: "Norway", lat: 59.9139, lng: 10.7522 },
      { name: "Letonia", geoName: "Latvia", lat: 56.9460, lng: 24.1059 },
      { name: "Tunez", geoName: "Tunisia", lat: 36.8065, lng: 10.1815 },
      { name: "Lituania", geoName: "Lithuania", lat: 54.6872, lng: 25.2797 },
      { name: "Eslovenia", geoName: "Slovenia", lat: 46.1512, lng: 14.9955 },
      { name: "Suecia", geoName: "Sweden", lat: 59.3293, lng: 18.0686 }
    ];

    // Update the GeoJSON section
    var countryLayers = {};

    // Add variable to store label markers
    var labelMarkers = {};

    var errorCount = 0;
    var isProcessing = false;
    var messageTimeout = null;

    function vibrate(pattern) {
      if (navigator.vibrate) {
        navigator.vibrate(pattern);
      }
    }

    function startGame() {
      document.getElementById('instructionsModal').style.display = 'none';
      
      // Show the clue container and sidebar with animation
      const clueContainer = document.getElementById('clueContainer');
      const countriesSidebar = document.querySelector('.countries-sidebar');
      
      clueContainer.classList.add('visible');
      countriesSidebar.classList.add('visible');
      
      errorCount = 0;
      document.getElementById("errorCount").innerHTML = "0 fallos";
      updateClue();
    }

    function updateClue() {
      if (currentClueIndex < clues.length) {
        const clueContainer = document.getElementById("clueContainer");
        const clueText = document.getElementById("clueText");
        const clueNumber = document.getElementById("clueNumber");
        const remainingCount = document.getElementById("remainingCount");

        // Add animation classes
        clueContainer.classList.add('animate');
        clueText.classList.add('animate');

        // Update the content
        clueNumber.innerHTML = `Afirmaci√≥n ${currentClueIndex + 1} de ${clues.length}`;
        clueText.innerHTML = clues[currentClueIndex].text;
        remainingCount.innerHTML = `${clues[currentClueIndex].remove.length} pa√≠ses restantes`;

        // Remove animation classes after animation completes
        setTimeout(() => {
          clueContainer.classList.remove('animate');
          clueText.classList.remove('animate');
        }, 500);

        // Add vibration feedback for new clue
        vibrate([50, 50, 50]);
      }
    }

    // Mover estas funciones fuera del fetch y antes de √©l
    function createCountriesList() {
      const countriesList = document.getElementById('countriesList');
      countriesList.innerHTML = ''; // Limpiar la lista primero
      candidates.forEach(candidate => {
        const li = document.createElement('li');
        li.className = 'country-item';
        li.id = `country-item-${candidate.name}`;
        li.textContent = candidate.name;
        li.onclick = () => {
          const layer = countryLayers[candidate.name];
          if (layer) {
            checkSelection(candidate.name, layer);
          }
        };
        countriesList.appendChild(li);
      });
    }

    function markCountryAsRemoved(country) {
      const countryItem = document.getElementById(`country-item-${country}`);
      if (countryItem) {
        countryItem.classList.add('removed');
      }
    }

    // Modificar el fetch para eliminar el c√≥digo duplicado y las definiciones de funciones
    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
      .then(response => response.json())
      .then(data => {
        // Add Liechtenstein manually if it's not in the GeoJSON
        const liechtensteinGeoJSON = {
          type: "Feature",
          properties: { name: "Liechtenstein" },
          geometry: {
            type: "Polygon",
            coordinates: [[
              [9.5357, 47.2496],
              [9.4797, 47.0547],
              [9.6321, 47.0572],
              [9.6355, 47.2701],
              [9.5357, 47.2496]
            ]]
          }
        };
        data.features.push(liechtensteinGeoJSON);

        L.geoJSON(data, {
          style: function(feature) {
            const hue = Math.random() * 360;
            return {
              fillColor: `hsl(${hue}, 70%, 85%)`,
              color: '#666',
              weight: 2,
              fillOpacity: 0.6
            };
          },
          filter: function(feature) {
            return candidates.some(c => 
              feature.properties.name === c.geoName ||
              feature.properties.name_long === c.geoName ||
              feature.properties.admin === c.geoName ||
              feature.properties.sovereignt === c.geoName
            );
          },
          onEachFeature: function(feature, layer) {
            let candidate = candidates.find(c => 
              c.geoName === feature.properties.name ||
              c.geoName === feature.properties.name_long ||
              c.geoName === feature.properties.admin ||
              c.geoName === feature.properties.sovereignt
            );

            if (candidate) {
              countryLayers[candidate.name] = layer;

              const center = layer.getBounds().getCenter();
              const labelMarker = L.marker(center, {
                icon: L.divIcon({
                  className: 'country-label',
                  html: `<div class="country-name">${candidate.name}</div>`,
                  iconSize: [100, 40],
                  iconAnchor: [50, 20]
                })
              }).addTo(map);

              labelMarkers[candidate.name] = labelMarker;

              labelMarker.on('click', function() {
                checkSelection(candidate.name, layer);
              });

              layer.on({
                click: function() {
                  checkSelection(candidate.name, layer);
                },
                mouseover: function(e) {
                  layer.setStyle({
                    fillOpacity: 0.8,
                    weight: 3
                  });
                },
                mouseout: function(e) {
                  layer.setStyle({
                    fillOpacity: 0.6,
                    weight: 2
                  });
                }
              });
            }
          }
        }).addTo(map);

        // Crear la lista de pa√≠ses despu√©s de que el mapa est√© listo
        createCountriesList();
      })
      .catch(error => {
        console.error('Error loading GeoJSON:', error);
        document.getElementById("message").className = "message-container error-message";
        document.getElementById("message").innerHTML = "Error cargando el mapa. Por favor, recarga la p√°gina.";
      });

    // A√±adir estilos para las etiquetas de pa√≠ses
    const style = document.createElement('style');
    style.textContent = `
      .country-label {
        background: transparent;
        border: none;
        box-shadow: none;
      }
      .country-label div {
        color: #333;
        font-weight: bold;
        font-size: 14px;
        text-shadow: 
          2px 2px 2px white,
          -2px 2px 2px white,
          2px -2px 2px white,
          -2px -2px 2px white;
        text-align: center;
        width: 100px;
        cursor: pointer;
      }
      .country-name:hover {
        color: #000;
        transform: scale(1.1);
        transition: all 0.2s ease;
      }
    `;
    document.head.appendChild(style);

    function showMessage(message, isSuccess) {
      const messageContainer = document.getElementById("message");
      
      // Clear any existing timeouts
      if (messageTimeout) {
        clearTimeout(messageTimeout);
        messageTimeout = null;
      }
      
      // If a message is currently animating out, remove the animation and show new message immediately
      if (messageContainer.classList.contains('hiding')) {
        messageContainer.classList.remove('hiding');
        messageContainer.style.display = 'block';
      }
      
      // Set the message and style
      messageContainer.innerHTML = message;
      messageContainer.className = `message-container ${isSuccess ? 'success-message' : 'error-message'}`;
      
      // Show the message
      messageContainer.style.display = 'block';
      
      // Set new timeout
      messageTimeout = setTimeout(() => {
        // Only start hiding if this is still the active timeout
        if (messageTimeout) {
          messageContainer.classList.add('hiding');
          setTimeout(() => {
            // Only hide if the message hasn't been updated
            if (messageContainer.classList.contains('hiding')) {
              messageContainer.style.display = 'none';
            }
          }, 500); // Animation duration
        }
      }, 4000);
    }

    function checkSelection(country, layer) {
      if (isProcessing) return;
      isProcessing = true;

      // Create celebration effect function
      function showAnimation(text, isSuccess) {
        // Add vibration patterns
        if (isSuccess) {
          vibrate([100]); // Short vibration for success
        } else {
          vibrate([100, 100, 100]); // Three short vibrations for error
        }

        const bounds = layer.getBounds();
        const center = bounds.getCenter();
        const point = map.latLngToContainerPoint(center);
        
        const celebration = document.createElement('div');
        celebration.className = `celebration ${isSuccess ? 'success' : 'error'}`;
        celebration.style.left = `${point.x}px`;
        celebration.style.top = `${point.y}px`;
        celebration.innerHTML = text;
        document.body.appendChild(celebration);
        
        setTimeout(() => {
          if (celebration.parentNode) {
            celebration.parentNode.removeChild(celebration);
          }
          isProcessing = false;
        }, 1000);
      }

      // Limpiar cualquier mensaje previo
      document.getElementById("message").innerHTML = "";
      document.getElementById("message").className = "message-container";

      if (clues[currentClueIndex].remove.includes(country)) {
        showAnimation('¬°Correcto! üéâ', true);
        
        // Add the animation class
        const countryItem = document.getElementById(`country-item-${country}`);
        if (countryItem) {
          countryItem.classList.add('correct');
          // Wait for the animation to complete before adding the removed class
          setTimeout(() => {
            countryItem.classList.add('removed');
          }, 500);
        }

        layer.setStyle({
          fillColor: '#808080',
          fillOpacity: 0.3,
          color: '#666',
          weight: 1
        });
        layer.off('mouseover mouseout click');

        if (labelMarkers[country]) {
          map.removeLayer(labelMarkers[country]);
          delete labelMarkers[country];
        }

        markCountryAsRemoved(country);

        const explanation = clues[currentClueIndex].explanations[country];
        showMessage(explanation, true);

        clues[currentClueIndex].remove = clues[currentClueIndex].remove.filter(c => c !== country);
        document.getElementById("remainingCount").innerHTML = `${clues[currentClueIndex].remove.length} pa√≠ses restantes`;

        if (clues[currentClueIndex].remove.length === 0) {
          currentClueIndex++;
          if (currentClueIndex >= clues.length) {
            // Wait for the message to finish before showing the final modal
            setTimeout(() => {
              document.getElementById("finalModal").style.display = "flex";
              document.getElementById("clueContainer").style.display = "none";
              document.getElementById("finalErrorCount").innerHTML = errorCount;
            }, 4500); // Wait for message display (4000) + animation (500)
          } else {
            updateClue();
          }
        }
      } else {
        showAnimation('¬°Incorrecto! ‚ùå', false);
        
        // Add and remove the incorrect animation class
        const countryItem = document.getElementById(`country-item-${country}`);
        if (countryItem) {
          countryItem.classList.add('incorrect');
          setTimeout(() => {
            countryItem.classList.remove('incorrect');
          }, 400);
        }

        errorCount++;
        document.getElementById("errorCount").innerHTML = `${errorCount} fallos`;
        showMessage("¬°Error! Este pa√≠s s√≠ cumple la afirmaci√≥n.", false);
      }
    }
  </script>
</body>
</html>
