<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Juego de Países</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
  <div id="map"></div>
  <div class="clue-container" id="clueContainer">
    <div class="clue-info">
      <span id="clueNumber">Afirmación 1 de 7</span>
      <div>
        <span class="remaining-countries" id="remainingCount"></span>
        <span class="error-counter" id="errorCount">0/3</span>
      </div>
    </div>
    <div class="clue-text" id="clueText"></div>
  </div>
  <div class="countries-sidebar">
    <div class="sidebar-title">Países Disponibles</div>
    <ul class="countries-list" id="countriesList">
      <!-- Countries will be added here dynamically -->
    </ul>
  </div>
  <div class="message-container" id="message"></div>
  <div class="modal-overlay" id="instructionsModal">
    <div class="modal">
      <h2>¡Bienvenido al juego que te llevará a tu destino sorpresa! 🎁</h2>
      
      <div class="instructions-content">
        <p class="main-description">Se te presentarán varias afirmaciones sobre países.</p>
        
        <div class="instructions-list">
          <p><strong>Tu objetivo:</strong> Identificar y hacer clic en los países que cumplen con la afirmación mostrada.</p>
          
          <ul>
            <li>Puedes hacer clic en el país directamente en el mapa o en su nombre en la lista a la izquierda para seleccionarlo</li>
            <li>Cuando selecciones todos los países que cumplan con una afirmación, pasarás a la siguiente.</li>
            <li>Los países que no cumplan con la afirmación se marcarán en rojo y serán descartados como posibles destinos</li>
      </ul>
          
          <p class="highlight-text">Al final del juego, ¡solo quedará tu destino sorpresa! 🎉</p>
          
          <p class="warning-text">⚠️ Importante: Con más de 3 fallos, se cancela automáticamente la reserva.</p>
        </div>
      </div>
      
      <button class="start-button" onclick="startGame()">¡Comenzar la Aventura!</button>
    </div>
  </div>
  <div class="modal-overlay" id="finalModal" style="display: none;">
    <div class="final-modal">
      <h2>¡Felicitaciones! 🎉</h2>
      
      <div class="victory-content">
        <p class="victory-message">Eres un as de la geopolítica! Pero eso ya lo sabíamos 😊</p>
        
        <div class="destination-reveal">
          <p class="reveal-text">Tu destino sorpresa son <strong>dos destinos</strong>:</p>
      <div class="final-countries">
            <div class="final-country">
              <span class="country-emoji">🇫🇮</span>
              <span class="country-name">Finlandia</span>
      </div>
            <div class="final-country">
              <span class="country-emoji">🇪🇪</span>
              <span class="country-name">Estonia</span>
    </div>
          </div>
        </div>
        
        <p class="error-summary">Total de fallos: <span id="finalErrorCount">0</span></p>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="gameOverModal" style="display: none;">
    <div class="final-modal game-over">
      <h2>Lo sentimos, ha perdido el juego y con ello, su sorpresa 💔</h2>
      
      <div class="game-over-content">
        <p class="restart-message">La buena noticia es que puede reiniciarlo.</p>
        <p class="condition-message">Solo debe decirle a su novia que es la mejor del mundo 😁</p>
        
        <button class="start-button" onclick="restartGame()">Reintentar</button>
      </div>
    </div>
  </div>
  <div class="level-banner" id="levelBanner">
    <h2>¡Afirmación 1 de 7! 🎯</h2>
    <p>¡Comencemos!</p>
  </div>
  <script>
    var clues = [
      { 
        text: "El inglés no es idioma oficial", 
        remove: ["Malta"],
        explanations: {
          "Malta": "Malta tiene el inglés como idioma oficial junto con el maltés desde su independencia en 1964"
        }
      },
      { 
        text: "El país está en Europa", 
        remove: ["Tunez", "Senegal"],
        explanations: {
          "Tunez": "Túnez está ubicado en el norte de África, en la costa mediterránea",
          "Senegal": "Senegal está ubicado en África occidental, bordeando el Océano Atlántico"
        }
      },
      { 
        text: "Tiene inviernos con temperaturas menores a 15°C", 
        remove: ["Portugal (Madeira)", "Chipre"],
        explanations: {
          "Portugal (Madeira)": "Madeira tiene un clima subtropical con inviernos suaves, temperaturas promedio entre 16-20°C",
          "Chipre": "Chipre tiene inviernos mediterráneos suaves con temperaturas promedio entre 15-18°C en la costa"
        }
      },
      { 
        text: "Tiene salida al mar", 
        remove: ["Liechtenstein", "Macedonia"],
        explanations: {
          "Liechtenstein": "Liechtenstein es un país sin salida al mar, ubicado entre Suiza y Austria",
          "Macedonia": "Macedonia del Norte es un país sin salida al mar en los Balcanes"
        }
      },
      { 
        text: "Específicamente, tiene acceso al mar Báltico", 
        remove: ["Croacia", "Eslovenia", "Noruega"],
        explanations: {
          "Croacia": "Croacia tiene costa en el mar Adriático, no en el mar Báltico",
          "Eslovenia": "Eslovenia tiene una pequeña costa en el mar Adriático, no en el mar Báltico",
          "Noruega": "Noruega tiene costa en el mar del Norte y mar de Noruega, pero no en el mar Báltico"
        }
      },
      { 
        text: "Su capital tiene salida a un golfo", 
        remove: ["Lituania"],
        explanations: {
          "Lituania": "Vilna, la capital de Lituania, está ubicada tierra adentro y no tiene acceso directo al mar"
        }
      },
      { 
        text: "A 80km por mar tiene otra capital europea", 
        remove: ["Letonia", "Suecia"],
        explanations: {
          "Letonia": "Riga, la capital de Letonia, está a más de 80km por mar de cualquier otra capital europea",
          "Suecia": "Estocolmo, la capital de Suecia, está a más de 80km por mar de cualquier otra capital europea"
        }
      }
    ];

    var currentClueIndex = 0;
    var map = L.map('map', {
        minZoom: 3,      // No permitir alejar más del zoom inicial
        maxZoom: 5       // Limitar también el zoom in para una mejor experiencia
        }).setView([55, 15], 3);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data © OpenStreetMap contributors'
    }).addTo(map);

        // Lista de candidatos actualizada con nombres en inglés para GeoJSON
    var candidates = [
      { name: "Portugal (Madeira)", geoName: "Portugal", lat: 32.7607, lng: -16.9595 },
      { name: "Finlandia", geoName: "Finland", lat: 60.1699, lng: 24.9384 },
      { name: "Chipre", geoName: "Cyprus", lat: 35.1264, lng: 33.4299 },
      { name: "Croacia", geoName: "Croatia", lat: 45.1000, lng: 15.2000 },
      { name: "Senegal", geoName: "Senegal", lat: 14.7167, lng: -17.4677 },
      { name: "Macedonia", geoName: "Macedonia", lat: 41.6086, lng: 21.7453 },
      { name: "Malta", geoName: "Malta", lat: 35.9375, lng: 14.3754 },
      { name: "Liechtenstein", geoName: "Liechtenstein", lat: 47.1660, lng: 9.5554 },
      { name: "Estonia", geoName: "Estonia", lat: 59.4370, lng: 24.7536 },
      { name: "Noruega", geoName: "Norway", lat: 59.9139, lng: 10.7522 },
      { name: "Letonia", geoName: "Latvia", lat: 56.9460, lng: 24.1059 },
      { name: "Tunez", geoName: "Tunisia", lat: 36.8065, lng: 10.1815 },
      { name: "Lituania", geoName: "Lithuania", lat: 54.6872, lng: 25.2797 },
      { name: "Eslovenia", geoName: "Slovenia", lat: 46.1512, lng: 14.9955 },
      { name: "Suecia", geoName: "Sweden", lat: 59.3293, lng: 18.0686 }
    ];

    // Update the GeoJSON section
    var countryLayers = {};

    // Add variable to store label markers
    var labelMarkers = {};

    var errorCount = 0;
    var isProcessing = false;
    var messageTimeout = null;
    var gameActive = true;
    var messageActive = false;

    // Add this variable with other global variables
    var disabledCountries = new Set();

    // Añadir esta variable con las otras variables globales
    var levelBannerActive = false;

    function vibrate(pattern) {
      if (navigator.vibrate) {
        navigator.vibrate(pattern);
      }
    }

    function startGame() {
      document.getElementById('instructionsModal').style.display = 'none';
      
      // Enable game
      gameActive = true;
      
      // Show the clue container and sidebar with animation
      const clueContainer = document.getElementById('clueContainer');
      const countriesSidebar = document.querySelector('.countries-sidebar');
      
      clueContainer.classList.add('visible');
      countriesSidebar.classList.add('visible');
      
      errorCount = 0;
      document.getElementById("errorCount").innerHTML = "0/3";
      
      // Clear any disabled states
      disabledCountries.clear();
      document.querySelectorAll('.temp-disabled').forEach(el => {
        el.classList.remove('temp-disabled');
      });
      
      // Re-enable all countries and their interactions
      candidates.forEach(candidate => {
        const layer = countryLayers[candidate.name];
        if (layer) {
          layer.setStyle({
            fillOpacity: 0.6,
            opacity: 1
          });
          layer.on('click', function() {
            checkSelection(candidate.name, layer);
          });
        }
        
        if (labelMarkers[candidate.name]) {
          const labelElement = labelMarkers[candidate.name].getElement();
          labelElement.classList.remove('temp-disabled');
          labelMarkers[candidate.name].on('click', function() {
            checkSelection(candidate.name, layer);
          });
        }
      });
      
      document.querySelectorAll('.country-item.temp-disabled').forEach(el => {
        el.classList.remove('temp-disabled');
      });
      
      updateClue();
    }

    function showLevelBanner(level, total, byElimination = false) {
        // Block interactions
        levelBannerActive = true;
        
        let banner = document.getElementById('levelBanner');
        if (!banner) {
            banner = document.createElement('div');
            banner.id = 'levelBanner';
            banner.className = 'level-banner';
            document.body.appendChild(banner);
        }

        banner.innerHTML = `
            <h2>¡Afirmación ${level} de ${total}! 🎯</h2>
            <p>${byElimination ? 
                '¡Has pasado por descarte! 🤔 La próxima intenta ser menos tonto 🫣' : 
                (level === 1 ? '¡Comencemos!' : '¡Excelente progreso!')}</p>
        `;

        // Show the banner
        banner.classList.remove('show');
        void banner.offsetWidth; // Force reflow
        banner.classList.add('show');

        // Tactile feedback
        vibrate([100, 50, 100]);
        
        // Clear any existing timeouts
        if (window.levelBannerTimeout) {
            clearTimeout(window.levelBannerTimeout);
        }
        
        // Unblock interactions after animation AND ensure banner is hidden
        window.levelBannerTimeout = setTimeout(() => {
            levelBannerActive = false;
            banner.classList.remove('show');
        }, byElimination ? 5000 : 2500); // Más tiempo si es por descarte
    }

    function updateClue() {
      if (currentClueIndex < clues.length) {
        // Mostrar el banner de nivel
        showLevelBanner(currentClueIndex + 1, clues.length);
        
        // Initialize correctlySelected for the new clue
        clues[currentClueIndex].correctlySelected = new Set();

        // Calculate available countries (excluyendo los eliminados)
        const availableCountries = candidates.filter(candidate => {
          // Un país está disponible si no está en disabledCountries
          return !disabledCountries.has(candidate.name);
        });

        // Calculate remaining countries from available ones
        const totalAvailable = availableCountries.length;
        const incorrectCountries = clues[currentClueIndex].remove.filter(country => 
          // Solo contar países incorrectos que aún están disponibles
          availableCountries.some(c => c.name === country)
        ).length;
        const correctCountries = totalAvailable - incorrectCountries;
        
        // Actualizar el contador de países restantes
        const remainingCount = document.getElementById("remainingCount");
        remainingCount.innerHTML = `${correctCountries} países restantes`;

        const clueContainer = document.getElementById("clueContainer");
        const clueText = document.getElementById("clueText");
        const clueNumber = document.getElementById("clueNumber");

        clueContainer.classList.add('new-clue');
        clueText.classList.add('new-clue');

        clueNumber.innerHTML = `Afirmación ${currentClueIndex + 1} de ${clues.length}`;
        clueText.innerHTML = clues[currentClueIndex].text;

        setTimeout(() => {
          clueContainer.classList.remove('new-clue');
          clueText.classList.remove('new-clue');
        }, 1000);

        vibrate([100, 50, 100]);
      }
    }

    // Mover estas funciones fuera del fetch y antes de él
    function createCountriesList() {
      const countriesList = document.getElementById('countriesList');
      countriesList.innerHTML = ''; // Limpiar la lista primero
      candidates.forEach(candidate => {
        const li = document.createElement('li');
        li.className = 'country-item';
        li.id = `country-item-${candidate.name}`;
        li.textContent = candidate.name;
        li.onclick = () => {
          const layer = countryLayers[candidate.name];
          if (layer) {
            checkSelection(candidate.name, layer);
          }
        };
        countriesList.appendChild(li);
      });
    }

    function markCountryAsRemoved(country) {
      const countryItem = document.getElementById(`country-item-${country}`);
      if (countryItem) {
        countryItem.classList.add('removed');
      }
    }

    // Modificar el fetch para eliminar el código duplicado y las definiciones de funciones
    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
      .then(response => response.json())
      .then(data => {
        // Add Liechtenstein manually if it's not in the GeoJSON
        const liechtensteinGeoJSON = {
          type: "Feature",
          properties: { name: "Liechtenstein" },
          geometry: {
            type: "Polygon",
            coordinates: [[
              [9.5357, 47.2496],
              [9.4797, 47.0547],
              [9.6321, 47.0572],
              [9.6355, 47.2701],
              [9.5357, 47.2496]
            ]]
          }
        };
        data.features.push(liechtensteinGeoJSON);

        L.geoJSON(data, {
          style: function(feature) {
            const hue = Math.random() * 360;
            return {
              fillColor: `hsl(${hue}, 70%, 85%)`,
              color: '#666',
              weight: 2,
              fillOpacity: 0.6
            };
          },
          filter: function(feature) {
            return candidates.some(c => 
              feature.properties.name === c.geoName ||
              feature.properties.name_long === c.geoName ||
              feature.properties.admin === c.geoName ||
              feature.properties.sovereignt === c.geoName
            );
          },
          onEachFeature: function(feature, layer) {
            let candidate = candidates.find(c => 
              c.geoName === feature.properties.name ||
              c.geoName === feature.properties.name_long ||
              c.geoName === feature.properties.admin ||
              c.geoName === feature.properties.sovereignt
            );

            if (candidate) {
              countryLayers[candidate.name] = layer;

              const center = layer.getBounds().getCenter();
              const labelMarker = L.marker(center, {
                icon: L.divIcon({
                  className: 'country-label',
                  html: `<div class="country-name">${candidate.name}</div>`,
                  iconSize: [100, 40],
                  iconAnchor: [50, 20]
                })
              }).addTo(map);

              labelMarkers[candidate.name] = labelMarker;

              labelMarker.on('click', function() {
                checkSelection(candidate.name, layer);
              });

              layer.on({
                click: function() {
                  checkSelection(candidate.name, layer);
                },
                mouseover: function(e) {
                  layer.setStyle({
                    fillOpacity: 0.8,
                    weight: 3
                  });
                },
                mouseout: function(e) {
                  layer.setStyle({
                    fillOpacity: 0.6,
                    weight: 2
                  });
                }
              });
            }
          }
        }).addTo(map);

        // Crear la lista de países después de que el mapa esté listo
        createCountriesList();
      })
      .catch(error => {
        console.error('Error loading GeoJSON:', error);
        document.getElementById("message").className = "message-container error-message";
        document.getElementById("message").innerHTML = "Error cargando el mapa. Por favor, recarga la página.";
      });

    function showMessage(message, isSuccess) {
      const messageContainer = document.getElementById("message");
      
      // Clear any existing timeouts
      if (messageTimeout) {
        clearTimeout(messageTimeout);
        messageTimeout = null;
      }
      
      // If a message is currently animating out, remove the animation and show new message immediately
      if (messageContainer.classList.contains('hiding')) {
        messageContainer.classList.remove('hiding');
        messageContainer.style.display = 'block';
      }
      
      // Set the message and style
      messageContainer.innerHTML = message;
      messageContainer.className = `message-container ${isSuccess ? 'success-message' : 'error-message'}`;
      
      // Show the message
      messageContainer.style.display = 'block';
      
      // Set new timeout
      messageTimeout = setTimeout(() => {
        // Only start hiding if this is still the active timeout
        if (messageTimeout) {
          messageContainer.classList.add('hiding');
          setTimeout(() => {
            // Only hide if the message hasn't been updated
            if (messageContainer.classList.contains('hiding')) {
              messageContainer.style.display = 'none';
            }
          }, 500); // Animation duration
        }
      }, 3000);
    }

    function createConfetti(isVictory = true) {
        const container = document.createElement('div');
        container.className = 'confetti-container';
        document.body.appendChild(container);

        const colors = isVictory ? 
            ['#4CAF50', '#45a049', '#gold', '#white', '#yellow'] : 
            ['#ff3333', '#cc0000', '#black', '#gray', '#darkred'];

        const confettiCount = 150;
        const gravity = 1;
        const terminalVelocity = 5;
        const drag = 0.075;

        for (let i = 0; i < confettiCount; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.animation = `${isVictory ? 'confettiFall' : 'gameOverFall'} ${3 + Math.random() * 2}s linear forwards`;
            confetti.style.animationDelay = Math.random() * 3 + 's';

            // Tamaño aleatorio
            const size = Math.random() * 10 + 5;
            confetti.style.width = `${size}px`;
            confetti.style.height = `${size}px`;

            // Forma aleatoria
            if (Math.random() > 0.5) {
                confetti.style.borderRadius = '50%';
            } else {
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
            }

            container.appendChild(confetti);
        }

        // Limpiar el confeti después de la animación
        setTimeout(() => {
            if (container && container.parentNode) {
                container.parentNode.removeChild(container);
            }
        }, 5000);
    }

    function checkSelection(country, layer) {
      if (isProcessing || !gameActive || disabledCountries.has(country) || levelBannerActive) return;
      isProcessing = true;

      // Create celebration effect function
      function showAnimation(text, isSuccess) {
        // Add vibration patterns
        if (isSuccess) {
          vibrate([100]); // Short vibration for success
        } else {
          vibrate([100, 100, 100]); // Three short vibrations for error
        }

        const bounds = layer.getBounds();
        const center = bounds.getCenter();
        const point = map.latLngToContainerPoint(center);
        
        const celebration = document.createElement('div');
        celebration.className = `celebration ${isSuccess ? 'success' : 'error'}`;
        celebration.style.left = `${point.x}px`;
        celebration.style.top = `${point.y}px`;
        celebration.innerHTML = text;
        document.body.appendChild(celebration);
        
        setTimeout(() => {
          if (celebration.parentNode) {
            celebration.parentNode.removeChild(celebration);
          }
          isProcessing = false;
        }, 1000);
      }

      // Limpiar cualquier mensaje previo
      document.getElementById("message").innerHTML = "";
      document.getElementById("message").className = "message-container";

      // Invert the logic: now we check if the country is NOT in the remove array
      if (!clues[currentClueIndex].remove.includes(country)) {
        showAnimation('¡Correcto! 🎉', true);
        
        const countryItem = document.getElementById(`country-item-${country}`);
        if (countryItem) {
          countryItem.classList.add('correct');
        }

        layer.setStyle({
          fillColor: '#4CAF50',
          fillOpacity: 0.6,
          color: '#45a049',
          weight: 1
        });
        layer.off('mouseover mouseout click');

        if (labelMarkers[country]) {
          map.removeLayer(labelMarkers[country]);
          delete labelMarkers[country];
        }

        // Show positive feedback message
        showMessage(`¡Correcto! ${country} sí cumple con la afirmación.`, true);

        // Add to list of correctly selected countries for this clue
        if (!clues[currentClueIndex].correctlySelected) {
          clues[currentClueIndex].correctlySelected = new Set();
        }
        clues[currentClueIndex].correctlySelected.add(country);

        // Actualizar el contador considerando solo países disponibles
        const availableCountries = candidates.filter(c => !disabledCountries.has(c.name));
        const totalAvailable = availableCountries.length;
        const incorrectCountries = clues[currentClueIndex].remove.filter(c => 
          availableCountries.some(ac => ac.name === c)
        ).length;
        const correctCountries = totalAvailable - incorrectCountries;
        const selectedCorrect = clues[currentClueIndex].correctlySelected.size;

        document.getElementById("remainingCount").innerHTML = 
          `${correctCountries - selectedCorrect} países restantes`;

        if (selectedCorrect === correctCountries) {
          // Block clicks immediately when clue is completed
          levelBannerActive = true;
          
          currentClueIndex++;
          
          if (currentClueIndex >= clues.length) {
            // Disable game immediately
            gameActive = false;
            
            // First update the final error count
            document.getElementById("finalErrorCount").innerHTML = errorCount;
            
            // Wait for the message to finish before showing the final modal and hiding elements
            setTimeout(() => {
              // Mostrar el confeti de victoria
              createConfetti(true);
              
              // Show final modal first
              document.getElementById("finalModal").style.display = "flex";
              
              // Then start the fade out animation for the containers
              const clueContainer = document.getElementById("clueContainer");
              const countriesSidebar = document.querySelector(".countries-sidebar");
              
              clueContainer.classList.remove('visible');
              countriesSidebar.classList.remove('visible');
              
              // After animation completes, hide completely
              setTimeout(() => {
                clueContainer.style.display = "none";
                countriesSidebar.style.display = "none";
              }, 300);
              
            }, 3500);
          } else {
            // Wait for message duration (3000) + animation duration (500) before showing banner
            setTimeout(() => {
              // Show the banner
              showLevelBanner(currentClueIndex + 1, clues.length, false);
              
              // Then process the country updates after banner shows
              setTimeout(() => {
                // Primero, deshabilitar y marcar en rojo los países que no cumplían la afirmación
                clues[currentClueIndex - 1].remove.forEach(countryToDisable => {
                  // Solo si el país no estaba ya deshabilitado (por un error del usuario)
                  if (!disabledCountries.has(countryToDisable)) {
                    const layerToDisable = countryLayers[countryToDisable];
                    const itemToDisable = document.getElementById(`country-item-${countryToDisable}`);
                    
                    // Deshabilitar y marcar en rojo el país en el mapa
                    if (layerToDisable) {
                      layerToDisable.setStyle({
                        fillColor: '#ff3333',
                        fillOpacity: 0.6,
                        color: '#cc0000',
                        weight: 2,
                        opacity: 0.8
                      });
                      layerToDisable.off('click mouseover mouseout');
                    }
                    
                    // Deshabilitar y marcar en rojo el país en la lista
                    if (itemToDisable) {
                      itemToDisable.classList.remove('correct'); // Remover la clase correct si existe
                      itemToDisable.classList.add('incorrect', 'temp-disabled');
                    }
                    
                    // Deshabilitar la etiqueta del país
                    if (labelMarkers[countryToDisable]) {
                      const labelElement = labelMarkers[countryToDisable].getElement();
                      labelElement.classList.add('temp-disabled');
                      labelMarkers[countryToDisable].off('click');
                    }
                    
                    disabledCountries.add(countryToDisable);
                  }
                });

                // Luego reactivar los países correctamente seleccionados
                clues[currentClueIndex - 1].correctlySelected.forEach(selectedCountry => {
                  const selectedLayer = countryLayers[selectedCountry];
                  const selectedItem = document.getElementById(`country-item-${selectedCountry}`);
                  
                  if (selectedLayer) {
                    const hue = Math.random() * 360;
                    selectedLayer.setStyle({
                      fillColor: `hsl(${hue}, 70%, 85%)`,
                      color: '#666',
                      weight: 2,
                      fillOpacity: 0.6,
                      opacity: 1
                    });
                    
                    selectedLayer.on({
                      click: function() {
                        checkSelection(selectedCountry, selectedLayer);
                      },
                      mouseover: function(e) {
                        selectedLayer.setStyle({
                          fillOpacity: 0.8,
                          weight: 3
                        });
                      },
                      mouseout: function(e) {
                        selectedLayer.setStyle({
                          fillOpacity: 0.6,
                          weight: 2
                        });
                      }
                    });
                  }
                  
                  if (!labelMarkers[selectedCountry]) {
                    const center = countryLayers[selectedCountry].getBounds().getCenter();
                    const labelMarker = L.marker(center, {
                      icon: L.divIcon({
                        className: 'country-label',
                        html: `<div class="country-name">${selectedCountry}</div>`,
                        iconSize: [100, 40],
                        iconAnchor: [50, 20]
                      })
                    }).addTo(map);

                    labelMarkers[selectedCountry] = labelMarker;
                    labelMarker.on('click', function() {
                      checkSelection(selectedCountry, countryLayers[selectedCountry]);
                    });
                  }
                  
                  if (selectedItem) {
                    selectedItem.classList.remove('correct', 'incorrect', 'temp-disabled');
                    selectedItem.style.background = '#f0f9f0';
                  }
                });

                // Actualizar la siguiente pista SIN mostrar el banner
                if (currentClueIndex < clues.length) {
                  // Initialize correctlySelected for the new clue
                  clues[currentClueIndex].correctlySelected = new Set();

                  // Calculate available countries
                  const availableCountries = candidates.filter(candidate => 
                    !disabledCountries.has(candidate.name)
                  );

                  // Calculate remaining countries
                  const totalAvailable = availableCountries.length;
                  const incorrectCountries = clues[currentClueIndex].remove.filter(country => 
                    availableCountries.some(c => c.name === country)
                  ).length;
                  const correctCountries = totalAvailable - incorrectCountries;
                  
                  // Update UI
                  const remainingCount = document.getElementById("remainingCount");
                  remainingCount.innerHTML = `${correctCountries} países restantes`;

                  const clueContainer = document.getElementById("clueContainer");
                  const clueText = document.getElementById("clueText");
                  const clueNumber = document.getElementById("clueNumber");

                  clueContainer.classList.add('new-clue');
                  clueText.classList.add('new-clue');

                  clueNumber.innerHTML = `Afirmación ${currentClueIndex + 1} de ${clues.length}`;
                  clueText.innerHTML = clues[currentClueIndex].text;

                  setTimeout(() => {
                    clueContainer.classList.remove('new-clue');
                    clueText.classList.remove('new-clue');
                  }, 1000);

                  vibrate([100, 50, 100]);
                }
              }, 2000);
            }, 3500); // Wait for message to complete
          }
        }
      } else {
        showAnimation('¡Incorrecto! ❌', false);
        
        // Disable and style the country item
        const countryItem = document.getElementById(`country-item-${country}`);
        if (countryItem) {
          countryItem.classList.add('incorrect');
          countryItem.classList.add('temp-disabled');
          disabledCountries.add(country);
        }
        
        // Disable the map layer and make it red
        layer.setStyle({
          fillColor: '#ff3333',
          fillOpacity: 0.6,
          color: '#cc0000',
          weight: 2,
          opacity: 0.8
        });
        layer.off('click');
        
        // Disable the label
        if (labelMarkers[country]) {
          const labelElement = labelMarkers[country].getElement();
          labelElement.classList.add('temp-disabled');
          labelMarkers[country].off('click');
        }

        errorCount++;
        document.getElementById("errorCount").innerHTML = `${errorCount}/3`;
        
        // Show explanation for incorrect selection
        const explanation = clues[currentClueIndex].explanations[country];
        showMessage(explanation || "¡Error! Este país no cumple la afirmación.", false);

        // Verificar si perdió (3 fallos) antes de continuar con cualquier otra lógica
        if (errorCount >= 3) {
          // Disable game immediately
          gameActive = false;
          
          // Wait for the error message to complete before showing game over
          setTimeout(() => {
            // Mostrar el confeti de derrota
            createConfetti(false);
            
            const clueContainer = document.getElementById("clueContainer");
            const countriesSidebar = document.querySelector(".countries-sidebar");
            
            clueContainer.classList.remove('visible');
            countriesSidebar.classList.remove('visible');
            
            // After fade-out animation, show game over modal
            setTimeout(() => {
              clueContainer.style.display = "none";
              countriesSidebar.style.display = "none";
              document.getElementById("gameOverModal").style.display = "flex";
            }, 300);
          }, 3500);
          
          return; // Salir de la función sin procesar la lógica de cambio de afirmación
        }

        // Verificar si todos los países incorrectos han sido seleccionados
        const availableCountries = candidates.filter(c => !disabledCountries.has(c.name));
        const remainingIncorrect = clues[currentClueIndex].remove.filter(country => 
            availableCountries.some(c => c.name === country)
        );

        if (remainingIncorrect.length === 0) {
            // Block clicks immediately
            levelBannerActive = true;
            currentClueIndex++;
            
            if (currentClueIndex >= clues.length) {
                // Disable game immediately
                gameActive = false;
                
                // First update the final error count
                document.getElementById("finalErrorCount").innerHTML = errorCount;
                
                // Wait for the message to finish before showing the final modal and hiding elements
                setTimeout(() => {
                    // Mostrar el confeti de victoria
                    createConfetti(true);
                    
                    // Show final modal first
                    document.getElementById("finalModal").style.display = "flex";
                    
                    // Then start the fade out animation for the containers
                    const clueContainer = document.getElementById("clueContainer");
                    const countriesSidebar = document.querySelector(".countries-sidebar");
                    
                    clueContainer.classList.remove('visible');
                    countriesSidebar.classList.remove('visible');
                    
                    // After animation completes, hide completely
                    setTimeout(() => {
                        clueContainer.style.display = "none";
                        countriesSidebar.style.display = "none";
                    }, 300);
                    
                }, 3500);
            } else {
                // Wait for message duration (3000) + animation duration (500) before showing banner
                setTimeout(() => {
                    // Show the banner
                    showLevelBanner(currentClueIndex + 1, clues.length, true);
                    
                    // Then process the country updates after banner shows
                    setTimeout(() => {
                        // Primero, deshabilitar y marcar en rojo los países que no cumplían la afirmación
                        clues[currentClueIndex - 1].remove.forEach(countryToDisable => {
                            // Solo si el país no estaba ya deshabilitado (por un error del usuario)
                            if (!disabledCountries.has(countryToDisable)) {
                                const layerToDisable = countryLayers[countryToDisable];
                                const itemToDisable = document.getElementById(`country-item-${countryToDisable}`);
                                
                                // Deshabilitar y marcar en rojo el país en el mapa
                                if (layerToDisable) {
                                    layerToDisable.setStyle({
                                        fillColor: '#ff3333',
                                        fillOpacity: 0.6,
                                        color: '#cc0000',
                                        weight: 2,
                                        opacity: 0.8
                                    });
                                    layerToDisable.off('click mouseover mouseout');
                                }
                                
                                // Deshabilitar y marcar en rojo el país en la lista
                                if (itemToDisable) {
                                    itemToDisable.classList.remove('correct'); // Remover la clase correct si existe
                                    itemToDisable.classList.add('incorrect', 'temp-disabled');
                                }
                                
                                // Deshabilitar la etiqueta del país
                                if (labelMarkers[countryToDisable]) {
                                    const labelElement = labelMarkers[countryToDisable].getElement();
                                    labelElement.classList.add('temp-disabled');
                                    labelMarkers[countryToDisable].off('click');
                                }
                                
                                disabledCountries.add(countryToDisable);
                            }
                        });

                        // Luego reactivar los países correctamente seleccionados
                        clues[currentClueIndex - 1].correctlySelected.forEach(selectedCountry => {
                            const selectedLayer = countryLayers[selectedCountry];
                            const selectedItem = document.getElementById(`country-item-${selectedCountry}`);
                            
                            if (selectedLayer) {
                                const hue = Math.random() * 360;
                                selectedLayer.setStyle({
                                    fillColor: `hsl(${hue}, 70%, 85%)`,
                                    color: '#666',
                                    weight: 2,
                                    fillOpacity: 0.6,
                                    opacity: 1
                                });
                                
                                selectedLayer.on({
                                    click: function() {
                                        checkSelection(selectedCountry, selectedLayer);
                                    },
                                    mouseover: function(e) {
                                        selectedLayer.setStyle({
                                            fillOpacity: 0.8,
                                            weight: 3
                                        });
                                    },
                                    mouseout: function(e) {
                                        selectedLayer.setStyle({
                                            fillOpacity: 0.6,
                                            weight: 2
                                        });
                                    }
                                });
                            }
                            
                            if (!labelMarkers[selectedCountry]) {
                                const center = countryLayers[selectedCountry].getBounds().getCenter();
                                const labelMarker = L.marker(center, {
                                    icon: L.divIcon({
                                        className: 'country-label',
                                        html: `<div class="country-name">${selectedCountry}</div>`,
                                        iconSize: [100, 40],
                                        iconAnchor: [50, 20]
                                    })
                                }).addTo(map);

                                labelMarkers[selectedCountry] = labelMarker;
                                labelMarker.on('click', function() {
                                    checkSelection(selectedCountry, countryLayers[selectedCountry]);
                                });
                            }
                            
                            if (selectedItem) {
                                selectedItem.classList.remove('correct', 'incorrect', 'temp-disabled');
                                selectedItem.style.background = '#f0f9f0';
                            }
                        });

                        // Actualizar la siguiente pista SIN mostrar el banner
                        if (currentClueIndex < clues.length) {
                            // Initialize correctlySelected for the new clue
                            clues[currentClueIndex].correctlySelected = new Set();

                            // Calculate available countries
                            const availableCountries = candidates.filter(candidate => 
                                !disabledCountries.has(candidate.name)
                            );

                            // Calculate remaining countries
                            const totalAvailable = availableCountries.length;
                            const incorrectCountries = clues[currentClueIndex].remove.filter(country => 
                                availableCountries.some(c => c.name === country)
                            ).length;
                            const correctCountries = totalAvailable - incorrectCountries;
                            
                            // Update UI
                            const remainingCount = document.getElementById("remainingCount");
                            remainingCount.innerHTML = `${correctCountries} países restantes`;

                            const clueContainer = document.getElementById("clueContainer");
                            const clueText = document.getElementById("clueText");
                            const clueNumber = document.getElementById("clueNumber");

                            clueContainer.classList.add('new-clue');
                            clueText.classList.add('new-clue');

                            clueNumber.innerHTML = `Afirmación ${currentClueIndex + 1} de ${clues.length}`;
                            clueText.innerHTML = clues[currentClueIndex].text;

                            setTimeout(() => {
                                clueContainer.classList.remove('new-clue');
                                clueText.classList.remove('new-clue');
                            }, 1000);

                            vibrate([100, 50, 100]);
                        }
                    }, 2000);
                }, 3500); // Wait for message to complete
            }
        }
      }
    }

    // Add these new functions after the startGame function
    function restartGame() {
      // Reset map view to initial position
      map.setView([55, 15], 3);
      
      // Hide game over modal
      document.getElementById('gameOverModal').style.display = 'none';
      
      // Enable game
      gameActive = true;
      
      // Reset the game state
      currentClueIndex = 0;
      errorCount = 0;
      
      // Reset all countries
      candidates.forEach(candidate => {
        const layer = countryLayers[candidate.name];
        if (layer) {
          // Generate a new random color for each country
          const hue = Math.random() * 360;
          layer.setStyle({
            fillColor: `hsl(${hue}, 70%, 85%)`,
            color: '#666',
            weight: 2,
            fillOpacity: 0.6,
            opacity: 1
          });
          
          // Re-attach all event listeners
          layer.on({
            click: function() {
              checkSelection(candidate.name, layer);
            },
            mouseover: function(e) {
              layer.setStyle({
                fillOpacity: 0.8,
                weight: 3
              });
            },
            mouseout: function(e) {
              layer.setStyle({
                fillOpacity: 0.6,
                weight: 2
              });
            }
          });
        }
        
        // Remove old label if it exists
        if (labelMarkers[candidate.name]) {
          map.removeLayer(labelMarkers[candidate.name]);
          delete labelMarkers[candidate.name];
        }
        
        // Create new label
        const center = countryLayers[candidate.name].getBounds().getCenter();
        const labelMarker = L.marker(center, {
          icon: L.divIcon({
            className: 'country-label',
            html: `<div class="country-name">${candidate.name}</div>`,
            iconSize: [100, 40],
            iconAnchor: [50, 20]
          })
        }).addTo(map);

        labelMarkers[candidate.name] = labelMarker;
        labelMarker.on('click', function() {
          checkSelection(candidate.name, countryLayers[candidate.name]);
        });
      });
      
      // Recreate the entire countries list to ensure a fresh start
      createCountriesList();
      
      // Reset clues
      clues.forEach(clue => {
        clue.remove = [...clue.originalRemove];
      });
      
      // Show UI elements
      const clueContainer = document.getElementById('clueContainer');
      const countriesSidebar = document.querySelector('.countries-sidebar');
      
      clueContainer.style.display = '';
      countriesSidebar.style.display = '';
      clueContainer.classList.add('visible');
      countriesSidebar.classList.add('visible');
      
      // Reset error counter display
      document.getElementById("errorCount").innerHTML = "0/3";
      
      // Clear disabled states
      disabledCountries.clear();
      
      // Update first clue
      updateClue();
    }

    // Add this right after the clues array definition to store original remove arrays
    clues.forEach(clue => {
      clue.originalRemove = [...clue.remove];
    });
  </script>
</body>
</html>
